[gd_scene load_steps=8 format=3 uid="uid://dqv4mwwn1jody"]

[ext_resource type="Material" uid="uid://b2gwvhnvtq2u" path="res://materials/vulture_body.tres" id="1_w3e2l"]
[ext_resource type="Material" uid="uid://hbxci5d5nvgb" path="res://materials/vulture_head.tres" id="2_17juh"]

[sub_resource type="GDScript" id="GDScript_6od1j"]
resource_name = "orbit"
script/source = "@tool
extends Node3D

@export var num_birds: int = 3 : set = _set_num
@export var radius: float = 10.0
@export var height: float = 40.0
@export var start_phase_deg: float = 0.0
@export var orbit_deg_per_sec: float = 18.0
@export var direction: int = 1      # 1 = CCW, -1 = CW
@export var bank_deg: float = 12.0
@export var rebuild_now: bool = false : set = _trigger_rebuild

var _proto_pivot: Node3D
var _pivots: Array[Node3D] = []

func _ready() -> void:
    _find_prototype()
    _rebuild()

func _process(delta: float) -> void:
    if Engine.is_editor_hint():
        return

    var yaw_step := deg_to_rad(orbit_deg_per_sec) * delta * float(direction)
    for pivot in _pivots:
        if pivot.get_child_count() == 0: continue
        var bird := pivot.get_child(0) as Node3D

        pivot.rotate_y(yaw_step)

        var tangent := (-pivot.basis.z * float(direction)).normalized()
        bird.look_at(bird.global_position + tangent, Vector3.UP)

        var to_center := (pivot.global_position - bird.global_position).normalized()
        var side: float = sign(float(tangent.cross(to_center).y))
        bird.rotation_degrees.z = bank_deg * side   # note: removed the minus
        
        

# --- Helpers ---

func _find_prototype() -> void:
    if get_child_count() == 0:
        push_error(\"Thermal needs 1 child Pivot with a Bird\")
        return
    _proto_pivot = get_child(0) as Node3D

func _set_num(v: int) -> void:
    num_birds = max(1, v)
    if is_inside_tree():
        _rebuild()

func _trigger_rebuild(_v: bool) -> void:
    rebuild_now = false
    if is_inside_tree():
        _rebuild()

func _clear_generated() -> void:
    for c in get_children():
        if c == _proto_pivot: continue
        c.queue_free()
    _pivots.clear()

func _rebuild() -> void:
    _find_prototype()
    if not _proto_pivot: return
    _clear_generated()

    _proto_pivot.name = \"Pivot1\"
    _pivots.append(_proto_pivot)

    for i in range(2, num_birds + 1):
        var clone := _proto_pivot.duplicate(DUPLICATE_USE_INSTANTIATION) as Node3D
        clone.name = \"Pivot%d\" % i
        add_child(clone)
        _pivots.append(clone)

    var step := TAU / float(_pivots.size())
    var base := deg_to_rad(start_phase_deg)
    for i in _pivots.size():
        var pivot := _pivots[i]
        pivot.rotation = Vector3(0.0, base + step * float(i), 0.0)
        if pivot.get_child_count() > 0:
            var bird := pivot.get_child(0) as Node3D
            bird.position = Vector3(radius, height, 0.0)
            bird.rotation = Vector3.ZERO
"

[sub_resource type="BoxMesh" id="BoxMesh_w3e2l"]
size = Vector3(0.3, 0.3, 1)

[sub_resource type="BoxMesh" id="BoxMesh_17juh"]
size = Vector3(1.15, 0.05, 0.85)

[sub_resource type="CylinderMesh" id="CylinderMesh_6od1j"]
top_radius = 0.05
bottom_radius = 0.15
height = 0.26

[sub_resource type="BoxMesh" id="BoxMesh_o2rph"]
size = Vector3(0.1, 0.1, 0.1)

[node name="Thermal" type="Node3D"]
script = SubResource("GDScript_6od1j")
num_birds = 4
radius = 16.0
height = 80.0
orbit_deg_per_sec = 20.0
bank_deg = 30.0

[node name="Pivot1" type="Node3D" parent="."]

[node name="Bird" type="Node3D" parent="Pivot1"]

[node name="Model" type="Node3D" parent="Pivot1/Bird"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, -0.7965431)

[node name="body" type="MeshInstance3D" parent="Pivot1/Bird/Model"]
mesh = SubResource("BoxMesh_w3e2l")
skeleton = NodePath("../../../..")
surface_material_override/0 = ExtResource("1_w3e2l")

[node name="wings" type="Node3D" parent="Pivot1/Bird/Model"]

[node name="LeftWing" type="Node3D" parent="Pivot1/Bird/Model/wings"]

[node name="wing" type="MeshInstance3D" parent="Pivot1/Bird/Model/wings/LeftWing"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.6, 0, 0)
mesh = SubResource("BoxMesh_17juh")
skeleton = NodePath("../../../../../..")
surface_material_override/0 = ExtResource("1_w3e2l")

[node name="RightWing" type="Node3D" parent="Pivot1/Bird/Model/wings"]

[node name="wing" type="MeshInstance3D" parent="Pivot1/Bird/Model/wings/RightWing"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.6, 0, 0)
mesh = SubResource("BoxMesh_17juh")
skeleton = NodePath("../../../../../..")
surface_material_override/0 = ExtResource("1_w3e2l")

[node name="neck" type="Node3D" parent="Pivot1/Bird/Model"]
transform = Transform3D(1, 0, 0, 0, 0.8378902, -0.5458388, 0, 0.5458388, 0.8378902, 0, 0, -0.49990374)

[node name="MeshInstance3D" type="MeshInstance3D" parent="Pivot1/Bird/Model/neck"]
transform = Transform3D(1, 0, 0, 0, -4.371139e-08, 1, 0, -1, -4.371139e-08, 0, 0, -0.13)
mesh = SubResource("CylinderMesh_6od1j")
surface_material_override/0 = ExtResource("1_w3e2l")

[node name="head" type="Node3D" parent="Pivot1/Bird/Model/neck"]
transform = Transform3D(1, 0, 0, 0, 0.84372896, 0.5367696, 0, -0.5367696, 0.84372896, 0, -2.9802322e-08, -0.2588978)

[node name="MeshInstance3D" type="MeshInstance3D" parent="Pivot1/Bird/Model/neck/head"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, -0.05)
mesh = SubResource("BoxMesh_o2rph")
skeleton = NodePath("../..")
surface_material_override/0 = ExtResource("2_17juh")
